#!/usr/bin/env python3
"""
SPARK ì—ì´ì „íŠ¸ ë³€í™˜ ëª…ë ¹ì–´
ì‚¬ìš©ë²•: spark-convert-agents [ì˜µì…˜]
"""

import os
import sys
import argparse
from pathlib import Path

def convert_md_to_txt(agents_dir, output_dir=None, combine=True, verbose=True):
    """
    agents ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  .md íŒŒì¼ì„ .txtë¡œ ë³€í™˜
    """
    agents_path = Path(agents_dir)
    
    if not agents_path.exists():
        print(f"âŒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {agents_dir}")
        return False
    
    # ì¶œë ¥ ë””ë ‰í† ë¦¬ ì„¤ì •
    if output_dir:
        output_path = Path(output_dir)
    else:
        output_path = agents_path.parent / "agents_txt"
    
    output_path.mkdir(exist_ok=True, parents=True)
    
    # .md íŒŒì¼ ì°¾ê¸°
    md_files = list(agents_path.glob("*.md"))
    
    if not md_files:
        print(f"âš ï¸ {agents_dir}ì— .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return False
    
    if verbose:
        print(f"ğŸ“ ì¶œë ¥ ë””ë ‰í† ë¦¬: {output_path}")
        print(f"ğŸ“ {len(md_files)}ê°œì˜ .md íŒŒì¼ì„ ë³€í™˜í•©ë‹ˆë‹¤...\n")
    
    converted_count = 0
    for md_file in md_files:
        try:
            # .txt íŒŒì¼ ê²½ë¡œ ìƒì„±
            txt_filename = md_file.stem + ".txt"
            txt_path = output_path / txt_filename
            
            # íŒŒì¼ ë‚´ìš© ì½ê¸°
            with open(md_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # .txt íŒŒì¼ë¡œ ì €ì¥
            with open(txt_path, 'w', encoding='utf-8') as f:
                f.write(content)
            
            if verbose:
                print(f"âœ… {md_file.name} â†’ {txt_filename}")
            converted_count += 1
            
        except Exception as e:
            print(f"âŒ {md_file.name} ë³€í™˜ ì‹¤íŒ¨: {e}")
    
    if verbose:
        print(f"\nğŸ‰ ë³€í™˜ ì™„ë£Œ! {converted_count}/{len(md_files)} íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print(f"ğŸ“‚ ë³€í™˜ëœ íŒŒì¼ ìœ„ì¹˜: {output_path}")
    
    # í†µí•© íŒŒì¼ ìƒì„±
    if combine:
        if verbose:
            print("\nğŸ“š í†µí•© íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤...")
        
        combined_path = output_path / "all_agents_combined.txt"
        with open(combined_path, 'w', encoding='utf-8') as combined:
            combined.write("=" * 80 + "\n")
            combined.write("SPARK v3.5 - ëª¨ë“  ì—ì´ì „íŠ¸ ì •ì˜ í†µí•© íŒŒì¼\n")
            combined.write("=" * 80 + "\n\n")
            
            for md_file in sorted(md_files):
                with open(md_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                combined.write(f"\n{'='*80}\n")
                combined.write(f"íŒŒì¼: {md_file.name}\n")
                combined.write(f"{'='*80}\n\n")
                combined.write(content)
                combined.write("\n\n")
        
        if verbose:
            print(f"âœ… í†µí•© íŒŒì¼ ìƒì„±: {combined_path}")
    
    return True

def main():
    parser = argparse.ArgumentParser(
        description="SPARK ì—ì´ì „íŠ¸ MD íŒŒì¼ì„ TXTë¡œ ë³€í™˜",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ì˜ˆì‹œ:
  spark-convert-agents                    # ê¸°ë³¸ ë³€í™˜ (í†µí•© íŒŒì¼ í¬í•¨)
  spark-convert-agents --no-combine       # ê°œë³„ íŒŒì¼ë§Œ ë³€í™˜
  spark-convert-agents -o ~/Desktop       # ì¶œë ¥ ìœ„ì¹˜ ì§€ì •
  spark-convert-agents -q                 # ì¡°ìš©í•œ ëª¨ë“œ
  
ì¶œë ¥:
  - ê°œë³„ .txt íŒŒì¼ë“¤
  - all_agents_combined.txt (í†µí•© íŒŒì¼, --no-combine ì œì™¸ ì‹œ)
        """
    )
    
    parser.add_argument(
        '-i', '--input',
        default="/Users/jason/Projects/spark-claude/.claude/agents",
        help='ì…ë ¥ ë””ë ‰í† ë¦¬ ê²½ë¡œ (ê¸°ë³¸ê°’: SPARK agents ë””ë ‰í† ë¦¬)'
    )
    
    parser.add_argument(
        '-o', '--output',
        help='ì¶œë ¥ ë””ë ‰í† ë¦¬ ê²½ë¡œ (ê¸°ë³¸ê°’: agents_txt)'
    )
    
    parser.add_argument(
        '--no-combine',
        action='store_true',
        help='í†µí•© íŒŒì¼ì„ ìƒì„±í•˜ì§€ ì•ŠìŒ'
    )
    
    parser.add_argument(
        '-q', '--quiet',
        action='store_true',
        help='ì¡°ìš©í•œ ëª¨ë“œ (ì§„í–‰ ìƒí™© ì¶œë ¥ ì•ˆ í•¨)'
    )
    
    args = parser.parse_args()
    
    if not args.quiet:
        print("ğŸš€ SPARK ì—ì´ì „íŠ¸ MD â†’ TXT ë³€í™˜")
        print("=" * 50)
    
    success = convert_md_to_txt(
        agents_dir=args.input,
        output_dir=args.output,
        combine=not args.no_combine,
        verbose=not args.quiet
    )
    
    return 0 if success else 1

if __name__ == "__main__":
    sys.exit(main())