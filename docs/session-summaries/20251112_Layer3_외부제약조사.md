# Layer 3 외부 제약 조사 결과 - 주식 거래 플랫폼

**날짜**: 2025-11-12
**작성자**: 2호 (Claude Code)
**목적**: Phase 2 주식 거래 플랫폼 Layer 3 분석 - 외부 제약 조사

---

## 🎯 조사 범위

주식 거래 플랫폼 구축 시 **외부에서 부과되는 제약사항**:
1. 증권사 API 기술 제약
2. 금융 규제 (법률)
3. 개인정보보호 및 보안 요구사항

---

## 📊 조사 결과 요약

### 증권사별 API 호출 제한 비교

| 증권사 | REST API | 초당 제한 | 시간당 제한 | API 방식 | 비고 |
|------|----------|----------|------------|---------|------|
| **한국투자증권** | ✅ | 20건 (실전), 2건 (모의) | - | REST + WebSocket | 최초 REST API 제공 (2022) |
| **키움증권** | ❌ | 5건 | 1000건 | COM/DLL (Windows) | 레퍼런스 가장 많음 |
| **이베스트투자증권** | ✅ | 10건 (모의) | - | REST + WebSocket | 수수료 저렴, 최근 REST 출시 |
| **대신증권** | ❌ | - | - | COM/DLL (Windows) | 전산 강자, 보안 이슈 |
| **NH투자증권** | ⚠️ | ? | ? | QV API | 정보 제한적 |
| **삼성증권** | ❌ | - | - | 기관/VVIP만 | 개인 사용 불가 |

### 공통 제약사항

| 항목 | 제약 수준 | 아키텍처 영향 | 비고 |
|------|----------|-------------|------|
| API 호출 제한 | 🔴 높음 | 설계 필수 고려 | 증권사마다 다름 (5~20건/초) |
| WebSocket 제한 | 🟡 중간 | 실시간 기능 제한 | 한투: 41건 |
| 데이터 보관 의무 | 🔴 높음 | 저장소 설계 필수 | 10년+ 보관 |
| 보안 인증 | 🟡 중간 | 인증 시스템 설계 | 토큰 또는 공인인증서 |
| 개인정보 처리 | 🔴 높음 | 암호화, 로깅 필수 | 접근 로그 1년 |
| OS 제약 | 🟡 중간 | 개발 환경 제한 | 키움/대신: Windows 필수 |

---

## 1️⃣ 증권사 API 제약 상세 비교

### A. 한국투자증권 Open API ⭐ (추천)

**장점**:
```
✅ REST API 제공 (국내 최초, 2022.04)
✅ 크로스 플랫폼 (Windows, Linux, macOS)
✅ ChatGPT, Claude 연동 샘플 제공
✅ 초당 20건 (증권사 중 가장 높음)
✅ API 사용료 무료
```

**단점**:
```
❌ 레퍼런스 상대적으로 적음 (2022년 출시)
```

#### REST API 호출 제한

**Rate Limiting**:
```
실전 투자 (Production):
- 초당 20건 (계좌 단위)
- 슬라이딩 윈도우 방식
- 접근토큰발급: 초당 1건

모의 투자 (Sandbox):
- 초당 2건 (실전의 1/10)
- 테스트 환경 제공
```

**아키텍처 영향**:
```
✅ 필수 구현:
1. 요청 큐잉 시스템
   - Redis Queue 또는 In-Memory Queue
   - 우선순위 처리 (거래 > 조회)

2. Throttling (쓰로틀링)
   - 초당 요청 수 제어
   - 경계점 요청 분산

3. 에러 처리
   - Rate Limit 초과 시 재시도
   - 백오프 전략

❌ 불가능:
- 실시간 틱 단위 모니터링 (초당 수백 건)
- 무제한 병렬 처리
```

### B. WebSocket 실시간 데이터

**제한 사항**:
```
1세션당 제한:
- 실시간 데이터 합산 41건
  - 실시간 체결가
  - 호가
  - 예상체결
  - 체결통보

- 국내/해외 주식, 파생 모두 포함
- 1계좌(앱키) = 1세션
```

**아키텍처 영향**:
```
✅ 설계 고려:
1. 관심 종목 제한
   - 최대 41개 종목 동시 모니터링
   - 우선순위 종목 선택 로직

2. 구독 관리
   - 동적 구독/해제
   - 사용자별 구독 최적화

3. 데이터 공유
   - 여러 사용자가 동일 종목 구독 시
   - WebSocket 1개로 공유

❌ 제약:
- 대량 종목 동시 모니터링 불가
- 모든 사용자에게 개별 WebSocket 불가
```

### C. 인증 방식

**방식**:
```
토큰 기반 인증:
1. Appkey + App secret → 접근토큰 발급
2. 토큰으로 API 호출
3. 토큰 만료 시 갱신

WebSocket:
1. 접속키 발급
2. WebSocket 연결
3. 실시간 데이터 수신
```

**아키텍처 영향**:
```
✅ 필수 구현:
1. 토큰 관리
   - 자동 갱신
   - 만료 처리

2. 키 보안
   - 환경 변수 저장
   - 암호화 저장

3. 세션 관리
   - WebSocket 재연결
   - 연결 상태 모니터링
```

### D. 비용

**수수료**:
```
✅ 무료:
- API 사용료 없음
- 매매수수료 = HTS 수수료와 동일

주의:
- 실제 매매 수수료는 별도
- 과도한 API 호출 시 제한 가능
```

---

### B. 키움증권 Open API+

**장점**:
```
✅ 레퍼런스 가장 많음 (오래된 API)
✅ 보안성 우수 (인증서 기반, 코드 노출 없음)
✅ API 사용료 무료
```

**단점**:
```
❌ Windows 전용 (COM/DLL)
❌ 초당 5건 (제한적)
❌ 시간당 1000건 제한
❌ 조건검색: 1분당 1회
```

**Rate Limiting**:
```
- 초당: 5회
- 시간당: 1000회
- 조건검색: 1분당 1회
```

**아키텍처 영향**:
```
⚠️ 제약:
- Windows 서버 필수
- Linux/Docker 배포 불가
- 한투 대비 4배 느림 (5건 vs 20건)
```

---

### C. 이베스트투자증권 Xing API

**장점**:
```
✅ REST API 제공 (최근 출시)
✅ 크로스 플랫폼
✅ 수수료 저렴
```

**단점**:
```
❌ 모의서버: 초당 10건 (실전 정보 부족)
❌ 레퍼런스 적음
```

**Rate Limiting**:
```
모의서버:
- 초당: 10건

실전:
- 정보 제한적 (추가 조사 필요)
```

---

### D. 대신증권 CYBOS PLUS API

**장점**:
```
✅ 전산 강자 (전통적 강점)
```

**단점**:
```
❌ Windows 전용 (COM/DLL)
❌ 보안 이슈 (자동로그인 시 인증 정보 노출)
❌ Rate Limit 정보 부족
```

**아키텍처 영향**:
```
⚠️ 보안 위험:
- 자동로그인 구현 시 인증서 비밀번호 노출 가능
```

---

### E. NH투자증권 QV API

**상태**:
```
⚠️ 정보 제한적
- QV Open API 제공
- Rate Limit 정보 없음
- 추가 조사 필요 (고객센터 문의)
```

---

### F. 삼성증권 API

**상태**:
```
❌ 개인 개발자 사용 불가
- 기관투자자 전용 (유료)
- VVIP 고객 (100억+ 자산) 제공
```

---

### 🎯 증권사 선택 기준

**개인 프로젝트 추천 순위**:
```
1위: 한국투자증권
   - REST API, 크로스 플랫폼
   - 초당 20건 (가장 빠름)
   - 현대적 개발 환경

2위: 이베스트투자증권
   - REST API, 수수료 저렴
   - 초당 10건 (모의)
   - 실전 정보 확인 필요

3위: 키움증권
   - 레퍼런스 많음
   - Windows 전용, 초당 5건
   - 기존 프로젝트 참고 용이

❌ 비추천:
- 대신증권: 보안 이슈
- NH투자증권: 정보 부족
- 삼성증권: 개인 사용 불가
```

---

## 2️⃣ 금융 규제 (법률)

### A. 자본시장법 (Capital Markets Act)

**투자자 보호 규정**:
```
KYC (Know-Your-Customer) Rule:
- 투자목적, 재산상태, 투자경험 파악
- 서면 확인 필수

적합성 원칙:
- 투자자 특성에 부적합한 투자권유 금지
```

**시스템 요구사항**:
```
주문입력창 설계:
✅ 필수:
- 단가입력란에 "원" 표시
- 단가/수량 입력란 색상 차별화
- 주문 실수 방지 UI

이유:
- 가격과 수량 바꿔 입력하는 실수 방지
```

**아키텍처 영향**:
```
✅ 구현 필요:
1. 사용자 정보 수집
   - KYC 정보 저장
   - 투자 성향 분석

2. UI/UX 규제 준수
   - 주문 확인 절차
   - 오입력 방지

3. 감사 로그
   - 투자권유 기록
   - 주문 기록
```

### B. 전자금융거래법

**2024 개정 사항**:
```
주요 규제 대상:
- 선불전자지급수단 (우리와 무관)
- 일반 전자금융거래

✅ 개인 거래 플랫폼 해당 사항:
- 전자서명 (필요 시)
- 거래 기록 관리
```

**아키텍처 영향**:
```
제한적:
- 증권사 API 통한 거래는 증권사가 규제 준수
- 우리는 중개 역할만
- 단, 거래 기록 보관은 필요할 수 있음
```

---

## 3️⃣ 개인정보보호 및 보안

### A. 개인정보 보관 의무

**법적 요구사항**:
```
금융투자회사 기준:
- 상업관계 종료 후 5년 이내 분리 저장
- 금융사고 조사, 분쟁 해결 목적: 10년+ 보관

개인정보보호법:
- 접근 로그: 최소 1년 보관
- 안전한 저장 및 관리
- 위조·변조·도난·분실 방지
```

**아키텍처 영향**:
```
✅ 필수 구현:
1. 데이터 보관 정책
   - 거래 기록: 10년+
   - 접근 로그: 1년+
   - 사용자 정보: 5년 (관계 종료 후)

2. 저장소 설계
   - 활성 데이터 vs 보관 데이터 분리
   - 아카이빙 전략
   - S3 Glacier (저비용 장기 보관)

3. 로깅 시스템
   - 모든 접근 기록
   - 위변조 방지 (불변 로그)
   - 검색 및 조회 기능
```

### B. 개인정보 보호

**2025년 가이드라인**:
```
개인정보 처리방침:
- 개인정보보호법 개정 (2024.09 시행)
- 2025.04 가이드라인 개정

개인정보 이전 기록:
- 전용 플랫폼에서 3년 보관
```

**아키텍처 영향**:
```
✅ 필수 구현:
1. 암호화
   - 저장 시 암호화 (at-rest)
   - 전송 시 암호화 (in-transit) - HTTPS/TLS
   - 데이터베이스 암호화

2. 접근 제어
   - RBAC (Role-Based Access Control)
   - 최소 권한 원칙
   - 2차 인증 (거래 시)

3. 개인정보 처리방침
   - 투명한 공개
   - 사용자 동의
   - 이전 기록 관리
```

### C. 보안 인증

**금융보안원**:
```
조사 결과:
- 대형 금융투자회사 대상
- 개인 프로젝트 수준: 직접 인증 불필요

✅ 우리 수준에서 필요:
- 기본 보안 준수
- 증권사 API 보안 정책 준수
- HTTPS, 토큰 보안
```

---

## 📋 Layer 3 제약사항 종합

### L3-Q1: 기술 스택 제약

**외부 제약 (증권사별 차이)**:
```
✅ 한국투자증권 선택 시:
- REST API: 초당 20건 (실전), 2건 (모의)
- WebSocket: 1세션당 41건
- 인증: 토큰 기반 (Appkey + App secret)
- 프로토콜: REST + WebSocket
- OS: 크로스 플랫폼 (Linux/Docker 가능)

⚠️ 키움증권 선택 시:
- REST API: 초당 5건, 시간당 1000건
- 인증: 공인인증서
- 프로토콜: COM/DLL (Windows)
- OS: Windows 전용 (서버 제약)

⚠️ 설계 필수 고려:
- 요청 큐잉 시스템
- Throttling
- WebSocket 구독 관리
- 토큰/인증서 갱신 시스템
```

### L3-Q2: 팀 역량 (Part 1에서 가정)

**추가 학습 필요 항목**:
```
금융 도메인:
✅ 필수 학습:
- 자본시장법 기본 (투자자 보호)
- KYC 프로세스
- 주문 UI/UX 규제

✅ 보안:
- 토큰 보안 관리
- 개인정보 암호화
- 접근 로그 구현
```

### L3-Q3: 배포 환경

**규제 영향**:
```
데이터 보관:
✅ 필요:
- 장기 저장소 (10년+)
- 로그 저장소 (1년+)
- 아카이빙 전략

클라우드 vs 온프레미스:
✅ 가능:
- 클라우드 사용 가능 (AWS, Azure, GCP)
- 국내 데이터 보관 의무는 특정 금융사에만 적용
- 개인 프로젝트: 클라우드 OK

⚠️ 주의:
- 개인정보 암호화 필수
- 백업 및 복구 전략
- 접근 제어
```

---

## 🔥 아키텍처 결정에 미치는 영향

### 1. Rate Limiting이 설계의 핵심!

```
Layer 2 NFR: 정확성 A + 즉시성 A
↓
Layer 3 제약:
- 한투: API 초당 20건
- 키움: API 초당 5건 (4배 느림!)
↓
충돌 발생! ⚠️

증권사 선택이 아키텍처를 결정!
- 한투 선택 → 20건/초 → 더 많은 실시간 처리 가능
- 키움 선택 → 5건/초 → 더 보수적 설계 필요

해결 필요:
- "정확성 100% + 즉시성" 불가능?
- 증권사별 트레이드오프 다름
- ADR 작성 필수!
```

### 2. WebSocket 41건 제한

```
사용자 100명 → 관심 종목 각 10개?
→ 1000개 구독 필요
→ WebSocket 41건 제한
→ 불가능!

해결 방안:
1. 우선순위 종목만 WebSocket
2. 나머지는 Polling (REST)
3. 사용자 간 데이터 공유
```

### 3. 데이터 보관 10년+

```
일 거래 10만 건 → 1년 3650만 건
→ 10년 3.65억 건

저장소 설계:
- Hot Storage: PostgreSQL (최근 1년)
- Cold Storage: S3 Glacier (9년)
- 로그: ElasticSearch (검색) + S3 (장기)
```

---

## 📝 다음 단계

### 1. Layer 3 통합 작성
- Part 1 (내부 결정) + Part 2 (외부 제약)
- 최종 Layer 3 답변 정리

### 2. 충돌 패턴 분석
```
충돌: 정확성 A + 즉시성 A vs API 초당 20건
→ ADR 작성
→ 트레이드오프 전략
```

### 3. 5단계 구현방법
- 제약사항 반영한 구현 전략
- 특히 2단계 "속성 질문"에 제약 반영

---

## 🎁 핵심 발견

### 1. Layer 3가 Layer 1-2만큼 중요!

```
금융 거래 시스템:
→ 규제와 제약이 아키텍처를 결정!
→ Layer 3 없이는 설계 불가능!
```

### 2. 외부 제약이 NFR 충돌 유발

```
Layer 2: 정확성 A + 즉시성 A
→ 이상적 목표

Layer 3: API 초당 20건
→ 현실적 제약

→ 트레이드오프 필수!
```

### 3. 개인 프로젝트도 규제 준수 필요

```
❌ "개인 프로젝트니까 대충"
✅ "금융 데이터 = 엄격한 보안과 보관"

- 개인정보 암호화
- 거래 기록 10년
- 접근 로그 1년
```

---

## 📚 참고 자료

### 조사 출처:
1. **한국투자증권 Open API**
   - 공식 포털: https://apiportal.koreainvestment.com
   - GitHub: https://github.com/koreainvestment/open-trading-api

2. **Rate Limiting 분석**
   - 실전: 초당 20건, 모의: 초당 2건
   - 슬라이딩 윈도우 방식
   - WebSocket: 1세션 41건

3. **금융 규제**
   - 자본시장법: KYC, 적합성 원칙, UI/UX 규제
   - 전자금융거래법: 2024 개정 (선불결제 중심)

4. **개인정보보호**
   - 금융투자회사 가이드라인: 10년+ 보관
   - 접근 로그: 1년+
   - 2025 개정 가이드라인 반영

---

**작성**: 2호 (Claude Code)
**조사 기간**: 2025-11-12
**상태**: Layer 3 Part 2 완료, 통합 작성 대기
**핵심**: 금융 거래 = 규제가 아키텍처를 결정!
