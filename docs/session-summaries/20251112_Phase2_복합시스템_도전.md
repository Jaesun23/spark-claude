# Phase 2: 복합 시스템 도전 - 주식 거래 플랫폼

**날짜**: 2025-11-12
**참여자**: Jason + 2호 (Claude Code)
**목적**: 3-Layer 프레임워크로 복합 시스템 분석 도전

---

## 🎯 현재 상황

### Phase 1 완료 ✅
- ✅ 이론적 매핑 완료 (ARCHITECTURE_THEORY_MAPPING.md)
- ✅ Layer 2 ↔ SEI Quality Attributes 검증
- ✅ Layer 1 ↔ Martin Fowler Patterns 검증
- ✅ 충돌 패턴 ↔ CAP/ACID/BASE 검증

### Phase 2 시작 🔄
- 목표: 실시간 스트리밍 패밀리 (패밀리 3) 사례 추가
- 선정: **주식 거래 플랫폼** (Jason이 나중에 실제 만들 시스템)

---

## 🔥 핵심 도전 과제 발견

### 복합 시스템의 복잡도

**시스템 구성**:
```
주식 거래 플랫폼 = 복합 시스템
├─ 1. 실시간 호가 스트리밍 (부가 기능)
│  └─ 역할: 최신 가격 정보 제공
│
└─ 2. 거래 (핵심 기능) 💥
   ├─ 구현 방식 A: 수동 거래
   │  └─ 사용자 클릭 → 거래 요청 → 체결
   └─ 구현 방식 B: 자동 거래
      ├─ 전략 1: 지정가 도달 시 매수
      ├─ 전략 2: % 변동 감지 시 매도
      └─ 전략 3: 정기 매수 (적립식)

   실패 영향: 거래 못 함 → 금전 손실 (A)
   → 구현 방식과 무관!
```

**핵심 인사이트**:
- **핵심 기능 = "거래" (하나!)**
- **수동/자동 = "구현 방식" (여러 개)**
- 거래 실패 = 금전 손실 (방식과 무관)

---

## 💡 Jason의 핵심 통찰

### "방법론의 본질"

```
❌ "복잡하니까 시스템을 쪼개자"
   → 구현 편의주의

✅ "3-Layer 질문이 이 복잡도를 해결하는가?"
   → 방법론 검증!
```

**Jason의 원칙**:
> "우리는 엔터프라이즈 기업의 소프트웨어 개발 방법을 연구하고 있어요.
> 복잡도를 떠나서 우리의 질문들이 어떻게 구성되어야
> 이 문제들을 해결할 시스템적 답안으로 이끌 것인가를 찾아야 한다는 거에요."

**검증 질문**:
```
현재 3-Layer 10개 질문으로
복합 시스템을 하나의 일관된 아키텍처로 이끌 수 있는가?

YES → 질문이 잘 설계됨 ✅
NO → 질문 수정/추가 필요 ⚠️
```

---

## 🎯 현재까지 분석 결과

### Layer 1: 아키텍처 패밀리 (핵심 기능 기준)

**판단 원칙**: "핵심 기능"의 **비즈니스 목적**으로 답변 (구현 방식 X)

**L1-Q1: 실패 파급력**
```
핵심 기능 = 거래 (Trading)
- 거래 요청 전달 실패 → 금전 손실
- 원하는 가격에 체결 못 함 → 금전 손실
- 수동/자동 무관, 모든 거래 실패가 치명적

선택: A (치명적) ✅
```

**L1-Q2: 정보 형태**
```
주가, 호가, 거래량 = 숫자 시계열
% 변동 계산, 이동평균
조건 비교 (지정가 도달 여부)

선택: C (숫자·분석 데이터) ✅
```

**L1-Q3: 응답 시점**
```
거래 요청 → 즉시 체결 필요
가격 변동 → 즉시 감지 필요
체결 완료 → 즉시 알림 필요

선택: A (즉각 응답) ✅
```

**→ 패밀리: A-C-A** 💥

**핵심 포인트**:
- ❌ "자동 거래"가 핵심 (구현 방식 기준)
- ✅ "거래 기능"이 핵심 (비즈니스 목적 기준)

### 🔥 중요 발견 1: 새로운 패밀리 패턴!

**기존 5개 패밀리**:
```
1. CRUD/트랜잭션 (A-A-A)
2. 검색/추천 (C-B-B)
3. 실시간 스트리밍 (B-C-A)
4. 협업/동기화 (B-A-A)
5. 분석/배치 (C-C-C)
```

**주식 거래 플랫폼**:
```
A-C-A ← 기존에 없던 조합!
```

**새 패밀리 후보**:
- **"실시간 트랜잭션"** 패밀리?
- 특성: 실패 치명적 + 숫자 데이터 + 즉각 응답
- 예시: 금융 거래, 자동화 시스템, IoT 제어

---

### Layer 2: NFR 우선순위

**L2-Q1: 핵심 품질**
```
A (가장 정확 - 100%) ✅
- 조건 감지 오류 = 금전 손실
- "70,000원 도달" 놓치면 안 됨
```

**L2-Q2: 규모**
```
B (B2C - 동시 1만 명) ✅
- 개인 투자자 플랫폼
```

**L2-Q3: 데이터 노출**
```
B (암호화 - 멀티 테넌트) ✅
- 개인 투자 내역 = 민감 정보
- 금융위원회 규제
```

**L2-Q4: 데이터 최신성**
```
A (즉시 반영 - 초 단위) ✅
- 호가 변동 즉시 반영
- 조건 감지 즉시 체결
```

**NFR 프로파일**: A-B-B-A

### 🔥 중요 발견 2: 충돌 패턴 예상

```
L2-Q1 (정확성 A: 100%) + L2-Q4 (즉시 A: 초 단위)
→ 100% 정확하게 + 즉시 감지/실행?
→ 가능한가? 트레이드오프 있나?
```

**예상 충돌**:
- 조건 감지의 정확성 vs 실시간 처리
- 모든 조건을 실시간으로 100% 정확히 감지 가능한가?

---

## 🤔 현재 질문 및 과제

### 질문 1: 패밀리 분류
- **A-C-A 패턴**을 어떻게 다룰 것인가?
  - 옵션 1: 6번째 패밀리 추가 ("실시간 트랜잭션")
  - 옵션 2: 기존 패밀리에 억지로 매핑
  - 옵션 3: 패밀리 수를 늘리는 게 맞는가?

### 질문 2: 복합 시스템 처리
- ✅ "핵심 기능" 판단 기준 명확화 완료
  - ❌ 구현 방식 (수동/자동)
  - ✅ 비즈니스 목적 (거래)
- 부가 기능(호가 스트리밍)은 어떻게 설계하나?
- Layer 1-2로 핵심 아키텍처 결정 → 부가 기능은 그 안에서 설계

### 질문 3: Layer 3 & 5단계
- Layer 3 (환경 제약) 적용 필요
- 5단계 구현방법 작성
- 충돌 패턴 해결 전략 도출

---

## 📝 다음 단계 (Context 복구 후)

### 1. Layer 3 완료 ✅

**접근 방식**: 내부 결정 사항 먼저 → 외부 제약 조사 → 통합 답변

#### Part 1: 우리가 결정/가정 가능한 항목 ✅

**L3-Q2: 팀 역량 (가정)**
```
팀 구성:
- 백엔드: 1-2명 (Python/Node.js)
- 프론트엔드: 1명 (React/Next.js)
- 금융 도메인 경험: 없음 (학습 필요)

기술 역량:
✅ 일반 웹 개발: 가능
✅ REST API, WebSocket: 가능
❓ 금융 규제 이해: 학습 필요
❓ 보안 인증: 학습 필요
```

**기술 스택 (제약 내 선택 가능)**
```
백엔드:
- FastAPI (Python) 또는 NestJS (Node.js)

프론트엔드:
- Next.js + React

실시간 통신:
- WebSocket (증권사 API 지원 시)
- Server-Sent Events (대안)

데이터:
- Redis (실시간 호가 캐싱)
- PostgreSQL (거래 기록, 사용자)
- TimescaleDB (시계열 데이터)
```

#### Part 2: 외부 제약 조사 완료 ✅

**조사 완료**: `20251112_Layer3_외부제약조사.md` 참고

**증권사 6개 비교 결과**:
```
| 증권사 | 초당 제한 | API 방식 | 개인 사용 |
|--------|-----------|----------|-----------|
| 한투 | 20건 | REST ✅ | 가능 ⭐ |
| 키움 | 5건 | COM/DLL | 가능 (Windows) |
| 이베스트 | 10건 | REST ✅ | 가능 |
| 대신 | ? | COM/DLL | 보안 이슈 ⚠️ |
| NH투자 | ? | QV API | 정보 부족 |
| 삼성 | - | - | 불가능 ❌ |

→ 한국투자증권 선택 (REST, 20건/초, 크로스 플랫폼)
```

**법적 규제 조사 결과**:
```
✅ 개인 사용:
- 5억원 미만 거래: 규제 없음
- 신고/인허가 불필요
- 거래 기록 보관 의무 없음
- 개인정보보호법 미적용

⚠️ 유일한 의무:
- 증권사 API 약관 준수
- 본인 계좌만 사용
- API 키 보안 관리

❌ 서비스화 시:
- 완전히 다른 차원의 규제 발생!
```

---

#### Part 3: Layer 3 최종 답변 (통합)

**L3-Q1: 기술 스택 제약은?**
```
외부 제약 (확정):
✅ 증권사: 한국투자증권
✅ API 방식: REST + WebSocket
✅ Rate Limit: 초당 20건 (실전), 2건 (모의)
✅ WebSocket: 1세션 41건
✅ 인증: 토큰 기반 (Appkey + App secret)
✅ OS: 크로스 플랫폼 (Linux/Docker 가능)
✅ 비용: API 무료

필수 구현:
- 요청 큐잉 시스템 (Redis Queue)
- Throttling (초당 20건 제한)
- WebSocket 구독 관리 (최대 41건)
- 토큰 갱신 자동화

선택 가능 (제약 내):
- 백엔드: FastAPI (Python) 또는 NestJS (Node.js)
- 프론트: Next.js + React
- 데이터: Redis, PostgreSQL, TimescaleDB
```

**L3-Q2: 팀 역량은?**
```
가정:
- 백엔드: 1-2명 (Python/Node.js)
- 프론트: 1명 (React/Next.js)
- 도메인 경험: 없음

필수 학습:
✅ 기술:
   - 증권사 API 사용법
   - WebSocket 실시간 통신
   - Rate Limiting 처리

✅ 보안 (권장):
   - API 키 보안 관리
   - 환경 변수 설정
   - Git 보안 (.gitignore)

❌ 불필요 (개인 사용):
   - 금융 규제 상세
   - KYC 프로세스
   - 개인정보보호법 상세
```

**L3-Q3: 배포 환경은?**
```
자유로운 선택:
✅ 클라우드 (AWS, Azure, GCP) 가능
✅ 로컬 서버 가능
✅ Docker 컨테이너 가능
✅ 한투 API = 크로스 플랫폼 OK

규제 제약 없음:
❌ 데이터 보관 의무 없음 (개인 사용)
❌ 국내 서버 의무 없음
❌ 금융보안원 인증 불필요

권장 사항 (선택):
- 안정적인 인터넷 연결
- 24/7 실행 환경 (거래 시간)
- 백업 (설정, 전략 코드)
```

### 2. 5단계 구현방법 작성
```
1단계: 기능 분해
  - 호가 스트리밍
  - 수동 거래
  - 자동 거래 (3가지 전략)

2단계: 속성 질문 ⭐
  - "조건 감지 정확도는?"
  - "호가 업데이트 지연은?"
  - "체결 응답 시간은?"

3단계: 제약조건
  - 거래소 API 호출 비용
  - 금융위원회 규제

4단계: 기술 옵션 탐색
  - WebSocket vs gRPC
  - Redis vs Kafka
  - 조건 감지 엔진?

5단계: 통합 설계
  - 전체 아키텍처
  - 데이터 흐름
```

### 3. 충돌 패턴 분석
```
충돌: 정확성 (A) + 즉시성 (A)
해결 전략: ???
ADR 작성: ???
```

### 4. Martin Fowler Patterns 매핑
```
A-C-A 패턴 → 어떤 Fowler Pattern?
- 실시간: Gateway (WebSocket)?
- 조건 감지: ???
- 자동 실행: Transaction Script?
```

---

## 🎁 핵심 교훈

### 1. 방법론 검증의 본질
```
❌ "사례를 방법론에 끼워 맞추기"
✅ "방법론이 사례를 해결하는지 검증"
```

### 2. 복잡도는 회피 대상이 아님
```
복잡한 시스템 = 방법론의 진짜 시험대
→ 여기서 막히면 질문 구조 개선 필요
→ 이게 진짜 "이론 검증"
```

### 3. 새로운 패턴 발견 = 성공
```
A-C-A 패턴 발견
→ 기존 5개 패밀리로 부족할 수 있음
→ 방법론 확장의 기회
```

---

## Part 4: 충돌 패턴 발견 및 분석 ⭐

### 🎯 충돌 패턴이란?

```
Layer 2: 이상적 목표 (NFR 우선순위)
         ↓
Layer 3: 현실적 제약 (외부 환경)
         ↓
      충돌 발견!
```

**핵심 원칙**:
- 충돌은 정상이다! (이상 vs 현실)
- 중요한 것: **의식적으로 트레이드오프 결정**
- ADR로 결정 근거 문서화

---

### 📋 Part 4 질문 체크리스트

#### Q4-1: NFR 달성 가능한가?

**Layer 2 목표 검토**:
```
NFR 프로파일: A-B-B-A

L2-Q1: 정확성 A (100% 정확)
→ 조건 감지 오류 = 금전 손실
→ "70,000원 도달" 놓치면 안 됨

L2-Q4: 최신성 A (초 단위 즉시)
→ 호가 변동 즉시 반영
→ 조건 감지 즉시 체결
```

**Layer 3 제약 확인**:
```
외부 API 제약:
- Rate Limit: 초당 20건 (실전)
- Rate Limit: 초당 2건 (모의)
- WebSocket: 41개 동시 구독
```

**달성 가능성 분석**:
```
✅ 가능한 것:
- 개별 거래 정확성 100% → API 자체가 보장
- 체결 즉시성 → WebSocket으로 즉시 알림

⚠️ 제약이 있는 것:
- 조건 감지 빈도 제한 → API 호출 제한
- 동시 감시 종목 수 제한 → WebSocket 41개
```

**결론**: ⚠️ **부분적 제약 존재**

---

#### Q4-2: 어떤 충돌이 있는가?

**충돌 #1: 정확성 A vs API Rate Limit**

```
목표 (L2-Q1):
- 정확성 A → 모든 조건을 100% 정확히 감지

현실 (L3):
- 초당 20건 제한 (실전)
- 초당 2건 제한 (모의)

충돌:
❌ 100개 조건을 초당 체크하려면?
   → 100건/초 필요 vs 20건/초 제한
   → 불가능!
```

**영향**:
- 조건 체크 주기가 길어짐 (5초마다 100개 체크 = 20건/초)
- 조건 만족 시점 감지 지연 가능
- 빠른 시장 변동 시 놓칠 위험

---

**충돌 #2: 즉시성 A vs WebSocket 구독 제한**

```
목표 (L2-Q4):
- 최신성 A → 호가 변동 즉시 반영

현실 (L3):
- WebSocket 41개 동시 구독 제한

충돌:
❌ 100개 종목을 실시간 감시하려면?
   → 100개 구독 필요 vs 41개 제한
   → 불가능!
```

**영향**:
- 전체 종목 실시간 감시 불가
- 우선순위 높은 41개만 WebSocket
- 나머지는 Polling (정확성·즉시성 하락)

---

**충돌 #3: 모의투자 vs 실전 투자 성능 차이**

```
목표:
- 모의투자로 전략 검증 후 실전 투자

현실:
- 모의투자: 초당 2건 제한 ⚠️
- 실전투자: 초당 20건 제한
- 10배 차이!

충돌:
❌ 모의투자 검증 결과를 실전에 적용 가능한가?
   → 제약이 달라서 동작이 다를 수 있음!
```

**영향**:
- 모의에서 성공한 전략이 실전에서 실패 가능
- 모의에서 충분한 테스트 불가능
- 전략 검증의 신뢰도 하락

---

#### Q4-3: 트레이드오프 필요한가?

**트레이드오프 #1: 정확성 vs 감시 범위**

```
Option A: 정확성 우선
- WebSocket 41개 + Polling 최소화
- 감시 범위: 41개 종목만 100% 정확
- 나머지는 포기

Option B: 범위 우선
- 100개 종목 모두 감시
- Polling (5초 주기) → 정확성 하락
- 빠른 변동 놓칠 위험

→ 결정 필요! (ADR #1)
```

---

**트레이드오프 #2: 즉시성 vs 비용**

```
Option A: 즉시성 최대화
- 조건 체크 주기 짧게 (1초)
- API 호출 많음 → Rate Limit 도달
- 추가 비용 발생 가능 (유료 플랜)

Option B: 비용 최소화
- 조건 체크 주기 길게 (5초)
- API 호출 적음 → 무료 플랜
- 즉시성 하락 (5초 지연)

→ 결정 필요! (ADR #2)
```

---

**트레이드오프 #3: 복잡도 vs 성능**

```
Option A: 단순 구조
- Queue 없이 직접 API 호출
- 구현 간단
- Rate Limit 초과 시 실패

Option B: 복잡한 구조
- Redis Queue + Throttling
- 구현 복잡
- Rate Limit 보장, 안정성 향상

→ 결정 필요! (ADR #3)
```

---

### 🎯 충돌 패턴 요약

| 충돌 | Layer 2 목표 | Layer 3 제약 | 심각도 |
|------|-------------|-------------|-------|
| #1: 조건 감지 | 정확성 A (100%) | API 20건/초 | 🔴 높음 |
| #2: 실시간 감시 | 즉시성 A (초 단위) | WebSocket 41개 | 🔴 높음 |
| #3: 모의 검증 | 전략 검증 신뢰 | 모의 2건/초 | 🟡 중간 |

**결론**:
- ✅ 개별 거래 정확성·즉시성은 달성 가능
- ⚠️ 대규모 감시·처리는 트레이드오프 필요
- 📝 ADR 3개 작성 필요

---

### 🔗 다음 단계

1. **ADR 작성** (3개)
   - ADR #1: 정확성 vs 감시 범위
   - ADR #2: 즉시성 vs 비용
   - ADR #3: 복잡도 vs 성능

2. **5단계 구현방법** 작성
   - 특히 Stage 2 (속성 질문) 중요!

3. **02-1_IMPLEMENTATION_CASES.md** 업데이트
   - Case 4: 주식 거래 플랫폼 (A-C-A)

---

## 📊 현재 검증 상태

| 항목 | 상태 | 비고 |
|------|------|------|
| Phase 1: 이론 매핑 | ✅ 완료 | SEI, Fowler, CAP 검증 완료 |
| 사례 1: 문서 생성 | ✅ 완료 | 패밀리 1 (A-A-A) |
| 사례 2: AI 메모리 | ✅ 완료 | 패밀리 2 (C-B-B), 충돌 해결 |
| 사례 3: 채팅 앱 | ✅ 완료 | 패밀리 3 (B-C-A) |
| **사례 4: 주식 거래** | 🔄 진행 중 | **패밀리 A-C-A** (새 패턴!) |
| Part 0: 핵심 기능 구분 | ✅ 완료 | 거래 = 1개 기능 |
| Layer 1-2 완료 | ✅ 완료 | A-C-A + NFR A-B-B-A |
| Layer 3 완료 | ✅ 완료 | 한국투자증권 선택, 규제 조사 |
| **충돌 패턴 분석** | ✅ 완료 | 3개 충돌 발견, ADR 필요 |
| ADR 작성 | ⏸️ 대기 | 3개 트레이드오프 |
| 5단계 구현방법 | ⏸️ 대기 | Stage 2 속성 질문 중심 |

---

## 🚀 현재 작업 진행 상황

### ✅ 완료된 작업
1. **Part 0: 핵심 기능 구분 명확화**
   - ❌ 수동/자동 = 2개 기능 → ✅ 거래 = 1개 기능
   - 문서: `20251112_핵심기능_판단기준.md`

2. **Part 1-2: Layer 1-2 분석 완료**
   - Layer 1: A-C-A (새 패밀리 패턴!)
   - Layer 2: A-B-B-A

3. **Part 3: Layer 3 완료**
   - Part 1: 내부 결정 사항 (팀 역량, 기술 스택)
   - Part 2: 외부 제약 조사 (증권사 API, 규제)
   - Part 3: 통합 답변 (한국투자증권 선택)
   - 문서: `20251112_Layer3_외부제약조사.md`

4. **Part 4: 충돌 패턴 분석 완료** ⭐
   - 충돌 #1: 정확성 A vs API 20건/초
   - 충돌 #2: 즉시성 A vs WebSocket 41개
   - 충돌 #3: 모의투자 vs 실전투자 성능 차이
   - 트레이드오프 3개 식별

### ⏸️ 대기 중
5. **ADR 템플릿** 3개 작성
   - ADR #1: 정확성 vs 감시 범위
   - ADR #2: 즉시성 vs 비용
   - ADR #3: 복잡도 vs 성능

6. **5단계 구현방법** 작성 (특히 Stage 2 속성 질문!)

7. **02-1_IMPLEMENTATION_CASES.md**에 사례 4 추가
   - Case 4: 주식 거래 플랫폼 (A-C-A)

8. **A-C-A 패밀리** 이론적 검증 (Fowler Pattern 매핑)

---

**작성**: 2호 (Claude Code)
**검토**: Jason
**상태**: Part 4 충돌 패턴 분석 완료
**핵심**: 충돌은 정상! 의식적으로 트레이드오프 결정하고 ADR로 문서화!
