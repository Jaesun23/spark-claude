# Stage 1: 아키텍처 결정 가이드 (Architecture Decision Guide)

**작성일**: 2025-11-12
**작성자**: Jason + 2호 (Claude Code)
**버전**: v1.0
**목적**: 3-Layer 프레임워크로 시스템 아키텍처 결정하기

---

## 📚 이 가이드의 위치

```
전체 프로세스:
Stage 0: 아이디어 → 핵심 정의 (01_CORE_DEFINITION_GUIDE.md)
Stage 1: 아키텍처 결정 ← 이 가이드 ⭐
Stage 2: 청사진 작성 (05_BLUEPRINT_GUIDE.md)
Stage 3: 작업 분해 (06_TASK_BREAKDOWN_GUIDE.md)
Stage 4: 체크리스트 (07_CHECKLIST_GUIDE.md)
Stage 5: 구현
```

**이 가이드에서 하는 것**:
- ✅ 핵심 기능 정확히 파악
- ✅ 3-Layer 질문으로 아키텍처 패밀리 결정
- ✅ 외부 제약 조사
- ✅ 충돌 패턴 발견 및 트레이드오프 결정

---

## 🎯 왜 이 가이드가 필요한가?

### Phase 2 주식 거래 플랫폼 사례에서 발견한 것들:

**발견 1: 핵심 기능을 잘못 구분하면 모든 게 틀어진다**
```
❌ 수동 거래 + 자동 거래 = 2개 핵심 기능
→ Layer 1 답변 혼란
→ 아키텍처 패밀리 선택 혼란

✅ 거래 = 1개 핵심 기능 (구현: 수동/자동)
→ Layer 1 일관된 답변
→ 명확한 아키텍처 결정
```

**발견 2: 외부 제약 조사 없이는 설계 불가능**
```
금융 거래 시스템:
- 증권사 API Rate Limit (5~20건/초)
- 증권사별 OS 제약 (Windows vs 크로스플랫폼)
- 법적 규제 (개인 vs 서비스)

→ Layer 3 조사 없이는 아키텍처 결정 불가!
```

**발견 3: Layer 2 NFR과 Layer 3 제약이 충돌한다**
```
Layer 2: 정확성 A + 즉시성 A (이상)
Layer 3: API 초당 20건 (현실)
→ 충돌! 트레이드오프 필요!

→ 충돌 패턴을 발견하고 해결해야 함
```

---

## Part 0: 준비 - 핵심 기능 정확히 파악하기 ⭐

### 🎯 목표

**Layer 1 질문에 답하기 전에 반드시 해야 할 것**:
- 시스템의 진짜 핵심 기능이 무엇인지 파악
- 구현 방식과 비즈니스 목적 구분
- 잘못된 기능 구분 방지

### ❓ 핵심 질문 3개

#### Q0-1: 비즈니스 목적으로 기능을 구분했는가?

**질문의 의도**:
```
구현 방식(How)이 아닌 비즈니스 목적(What)으로 기능을 구분했는지 확인
```

**체크 방법**:
```
✅ 올바른 구분:
- "거래" (목적)
  ├─ 구현 방식 A: 수동
  └─ 구현 방식 B: 자동

❌ 잘못된 구분:
- "수동 거래" (구현 방식)
- "자동 거래" (구현 방식)
→ 2개의 다른 핵심 기능으로 착각!
```

**실전 예시 - 주식 거래 플랫폼**:
```
❌ 초기 분석 (잘못):
핵심 기능 1: 수동 거래 (사용자 클릭)
핵심 기능 2: 자동 거래 (조건 기반)
→ L1-Q1 답변 혼란 (어느 걸 기준으로?)

✅ 수정 후 (올바름):
핵심 기능: 거래
├─ 구현 방식 A: 수동 (사용자 클릭)
└─ 구현 방식 B: 자동 (조건 기반)
→ L1-Q1: 거래 실패 = 금전 손실 (방식 무관) = A
```

**참고 문서**: `docs/session-summaries/20251112_핵심기능_판단기준.md`

---

#### Q0-2: 실패의 비즈니스 영향이 구현 방식과 무관한가?

**질문의 의도**:
```
여러 구현 방식이 동일한 비즈니스 영향을 가지면 → 하나의 핵심 기능
```

**체크 방법**:
```
주식 거래 예시:

방식 A (수동 거래) 실패:
- 사용자 클릭 → 체결 안 됨
- 원하는 가격에 못 삼
- 금전 손실 ✅

방식 B (자동 거래) 실패:
- 조건 충족 → 체결 안 됨
- 원하는 가격에 못 삼
- 금전 손실 ✅

→ 동일한 비즈니스 영향!
→ 하나의 핵심 기능 맞음!
```

---

#### Q0-3: 사용자 관점에서 결과가 무엇인가?

**질문의 의도**:
```
사용자는 "구현 방식"이 아니라 "결과"를 원한다
```

**체크 방법**:
```
주식 거래 예시:

사용자 관점:
❌ "자동으로 거래됐는지" 중요 (X)
✅ "원하는 가격에 거래됐는지" 중요 (O)

→ 구현 방식(수동/자동) 무관
→ 결과(거래 성공/실패)가 핵심
```

---

### 📋 Part 0 체크리스트

Layer 1로 넘어가기 전에 확인:

- [ ] 구현 방식(How)이 아닌 비즈니스 목적(What)으로 기능을 구분했는가?
- [ ] 여러 구현 방식이 동일한 비즈니스 영향을 가지는가?
- [ ] 사용자 관점에서 결과가 무엇인지 명확한가?
- [ ] 핵심 기능 개수가 명확한가? (2개인 줄 알았는데 사실 1개?)

---

## Part 1: Layer 1 - 아키텍처 패밀리 식별

### 🎯 목표

**핵심 기능의 특성**으로 아키텍처 패밀리 결정:
- L1-Q1: 실패 파급력
- L1-Q2: 정보 형태
- L1-Q3: 응답 시점

### ❗ 중요: Part 0 완료 후 진행!

```
Part 0에서 핵심 기능을 정확히 파악했다면:
→ Layer 1 질문의 답이 명확해짐
→ "어떤 기능 기준으로 답해야 하나?" 혼란 없음
```

### L1-Q1: 핵심 기능이 실패하면 얼마나 치명적인가?

**선택지**:
```
A: 치명적 (돈, 데이터 손실 / 법적 문제 / 복구 불가)
B: 중단 후 재시도 가능
C: 무시 가능 (나중에 처리)
```

**주식 거래 플랫폼 예시**:
```
핵심 기능: 거래

실패 시나리오:
- 거래 요청 실패 → 원하는 가격에 못 삼 → 금전 손실
- 수동이든 자동이든 동일한 영향
- 시장 변동으로 복구 불가

선택: A (치명적) ✅
```

### L1-Q2: 핵심 기능이 다루는 정보는 어떤 형태인가?

**선택지**:
```
A: 텍스트 중심 (문서, 글)
B: 멀티미디어 (이미지, 영상, 음성)
C: 숫자·분석 데이터 (통계, 계산, 시계열)
```

**주식 거래 플랫폼 예시**:
```
핵심 기능: 거래

다루는 정보:
- 주가, 호가, 거래량 = 숫자
- % 변동 계산, 이동평균 = 분석
- 시계열 데이터

선택: C (숫자·분석 데이터) ✅
```

### L1-Q3: 핵심 기능은 언제 응답해야 하는가?

**선택지**:
```
A: 즉각 (실시간, 밀리초~초)
B: 빠르게 (초~분)
C: 느려도 됨 (분~시간~일)
```

**주식 거래 플랫폼 예시**:
```
핵심 기능: 거래

타이밍 요구사항:
- 가격 변동 즉시 감지
- 거래 요청 즉시 체결
- 결과 즉시 알림

선택: A (즉각 응답) ✅
```

### 패밀리 결정

```
L1 답변: A-C-A

기존 5개 패밀리:
1. CRUD/트랜잭션 (A-A-A)
2. 검색/추천 (C-B-B)
3. 실시간 스트리밍 (B-C-A)
4. 협업/동기화 (B-A-A)
5. 분석/배치 (C-C-C)

→ A-C-A는 기존 패밀리에 없음!
→ 새 패밀리 발견 또는 추가 분석 필요
```

---

## Part 2: Layer 2 - NFR 우선순위 선택

### 🎯 목표

**핵심 기능의 비기능 요구사항(NFR) 우선순위** 결정:
- L2-Q1: 핵심 품질
- L2-Q2: 규모
- L2-Q3: 데이터 노출
- L2-Q4: 데이터 최신성

### L2-Q1: 핵심 품질은 무엇인가?

**선택지**:
```
A: 가장 정확 (100% 정확도, 0% 오류)
B: 가장 빠름 (속도 최우선)
C: 가장 저렴 (비용 최소화)
```

**주식 거래 플랫폼 예시**:
```
핵심 기능: 거래

품질 요구사항:
- 조건 감지 오류 = 금전 손실
- "70,000원 도달" 놓치면 안 됨
- 정확성이 최우선

선택: A (가장 정확) ✅
```

### L2-Q2: 예상 사용자 규모는?

**선택지**:
```
A: B2B/내부 (동시 ~100명)
B: B2C (동시 ~1만 명)
C: 대규모 (동시 10만+ 명)
```

**주식 거래 플랫폼 예시**:
```
개인 투자자 플랫폼
→ 예상 사용자: 수천~수만 명

선택: B (B2C) ✅
```

### L2-Q3: 데이터 노출 수준은?

**선택지**:
```
A: 공개 (누구나 볼 수 있음)
B: 암호화 (사용자별 격리, 멀티 테넌트)
C: 격리 (완전 분리, 싱글 테넌트)
```

**주식 거래 플랫폼 예시**:
```
개인 투자 내역 = 민감 정보
금융위원회 규제

선택: B (암호화 - 멀티 테넌트) ✅
```

### L2-Q4: 데이터 최신성 요구는?

**선택지**:
```
A: 즉시 (초 단위 반영)
B: 빠르게 (분 단위 반영)
C: 느려도 됨 (시간~일 단위)
```

**주식 거래 플랫폼 예시**:
```
핵심 기능: 거래

최신성 요구:
- 호가 변동 즉시 반영
- 조건 감지 즉시 실행
- 체결 결과 즉시 확인

선택: A (즉시 반영) ✅
```

### NFR 프로파일

```
L2 답변: A-B-B-A

해석:
- 정확성 최우선 (A)
- B2C 규모 (B)
- 데이터 암호화 (B)
- 즉시 최신성 (A)
```

---

## Part 3: Layer 3 - 환경 제약 ⭐

### 🎯 목표

**외부 제약 조건** 파악:
- L3-Q1: 기술 스택 제약 (외부 조사 필요!)
- L3-Q2: 팀 역량
- L3-Q3: 배포 환경

### ⚠️ 새로운 발견: 외부 제약 조사의 중요성!

```
Phase 2 주식 거래 플랫폼에서 발견:
"금융 거래는 일반 시스템과 완전히 다르다!"

→ 증권사 API 사용 조건 조사 필요
→ 법적 규제 조사 필요
→ 제공자마다 조건이 다름!

→ Layer 3 없이는 설계 불가능!
```

---

### L3-Q1: 기술 스택 제약은? (외부 조사!)

#### Step 1: 외부 제약이 있는 도메인인가?

**체크 질문**:
```
□ 외부 API/서비스를 사용하는가?
□ 금융, 의료, 정부 등 규제 도메인인가?
□ 여러 제공자(증권사, 결제사 등) 중 선택이 필요한가?
□ 사용 제한(Rate Limit, 비용, 조건)이 있을 가능성이 있는가?
```

**하나라도 Yes → 외부 제약 조사 필수!**

#### Step 2: 무엇을 조사해야 하는가?

**주식 거래 플랫폼 예시**:

**조사 항목**:
```
1. 증권사 API 비교
   □ 한국투자증권, 키움증권, 이베스트증권 등
   □ API 방식 (REST vs COM/DLL)
   □ Rate Limit (초당 몇 건?)
   □ OS 제약 (Windows vs 크로스플랫폼)
   □ 비용

2. 법적 규제
   □ 개인 사용 규제
   □ 서비스 제공 시 인허가
   □ 데이터 보관 의무

3. 개인정보보호
   □ 본인 정보만 처리 시
   □ 타인 정보 처리 시
```

**조사 결과 예시**:
```
증권사 API 비교:
| 증권사 | Rate Limit | API 방식 | OS 제약 |
|--------|------------|----------|---------|
| 한투 | 20건/초 | REST | 크로스 |
| 키움 | 5건/초 | COM/DLL | Windows |
| 이베스트 | 10건/초 | REST | 크로스 |

→ 증권사 선택이 아키텍처를 결정!
```

#### Step 3: 제약 사항 정리

**확정된 제약**:
```
한국투자증권 선택 시:
✅ REST API: 초당 20건
✅ WebSocket: 1세션 41건
✅ 인증: 토큰 기반
✅ OS: 크로스 플랫폼
✅ 비용: API 무료

⚠️ 필수 구현:
- 요청 큐잉 시스템
- Throttling
- WebSocket 구독 관리
- 토큰 갱신 시스템
```

**참고 문서**: `docs/session-summaries/20251112_Layer3_외부제약조사.md`

---

### L3-Q2: 팀 역량은?

**가정 또는 확인**:
```
팀 구성:
- 백엔드: 1-2명 (Python/Node.js)
- 프론트엔드: 1명 (React/Next.js)
- 도메인 경험: 없음 (학습 필요)

기술 역량:
✅ 일반 웹 개발: 가능
✅ REST API, WebSocket: 가능
❓ 도메인 특수 사항: 학습 필요
```

---

### L3-Q3: 배포 환경은?

**확인 사항**:
```
개인 사용 프로젝트:
✅ 클라우드 (AWS, Azure, GCP) 가능
✅ 로컬 서버 가능
✅ Docker 컨테이너 가능

⚠️ 증권사별 제약:
- 한투/이베스트: 크로스 플랫폼 OK
- 키움/대신: Windows 필수

❌ 규제 제약:
- 개인 사용: 대부분 없음
- 서비스 제공: 별도 규제
```

---

## Part 4: 충돌 패턴 발견 ⭐

### 🎯 목표

**Layer 2 NFR vs Layer 3 제약 충돌** 발견:
- 충돌이 있는가?
- 트레이드오프가 필요한가?
- ADR 작성이 필요한가?

### ⚠️ 새로운 발견: 충돌이 반드시 발생한다!

```
Phase 2에서 발견:
Layer 2에서는 이상적 목표 설정
Layer 3에서 현실적 제약 발견
→ 대부분 충돌 발생!

→ 충돌을 발견하고 해결하는 게 아키텍처 결정의 핵심!
```

---

### 충돌 체크 질문

#### Q4-1: Layer 2 NFR을 Layer 3 제약 내에서 달성 가능한가?

**주식 거래 플랫폼 예시**:
```
Layer 2 NFR:
- L2-Q1: 정확성 A (100% 정확)
- L2-Q4: 즉시성 A (초 단위)

Layer 3 제약:
- API 초당 20건

질문:
→ 초당 20건으로 100% 정확 + 즉시 감지 가능한가?
→ 관심 종목 50개 × 1초마다 확인 = 50건?
→ 불가능! 충돌 발생! ⚠️
```

#### Q4-2: 어떤 NFR과 어떤 제약이 충돌하는가?

**충돌 매트릭스 작성**:
```
| Layer 2 NFR | Layer 3 제약 | 충돌? | 영향 |
|-------------|--------------|-------|------|
| 정확성 A (100%) | API 20건/초 | ✅ | 모든 조건 실시간 감지 불가 |
| 즉시성 A (초 단위) | API 20건/초 | ✅ | 모든 종목 동시 모니터링 불가 |
| 보안 B (암호화) | HTTPS 기본 | ❌ | 충돌 없음 |
| 규모 B (1만 명) | WebSocket 41건 | ✅ | 서비스화 시 부족 |
```

#### Q4-3: 트레이드오프가 필요한가?

**의사결정 필요**:
```
정확성 A vs API 20건/초:

옵션 1: 정확성 우선
- 우선순위 종목만 실시간 (20개)
- 나머지는 주기적 폴링 (느림)
- 정확도 유지, 즉시성 일부 포기

옵션 2: 즉시성 우선
- 모든 종목 폴링 (50개)
- 2.5초마다 1회 확인 (20건 제한)
- 즉시성 유지, 정확도 위험

옵션 3: 균형
- 핵심 20개 실시간 (1초)
- 나머지 30개 주기적 (5초)
- 트레이드오프

→ ADR 작성 필요!
```

---

### 📋 Part 4 체크리스트

- [ ] Layer 2 NFR 목표를 Layer 3 제약 내에서 달성 가능한가?
- [ ] 충돌하는 NFR과 제약을 모두 식별했는가?
- [ ] 각 충돌에 대한 트레이드오프 옵션을 정리했는가?
- [ ] ADR 작성이 필요한 중요한 결정이 있는가?

---

## 📊 전체 프로세스 요약

```
Part 0: 핵심 기능 파악 ⭐
├─ Q0-1: 비즈니스 목적으로 구분했는가?
├─ Q0-2: 실패 영향이 구현 방식과 무관한가?
└─ Q0-3: 사용자 관점에서 결과가 무엇인가?
   ↓
Part 1: Layer 1 (아키텍처 패밀리)
├─ L1-Q1: 실패 파급력
├─ L1-Q2: 정보 형태
└─ L1-Q3: 응답 시점
   ↓
Part 2: Layer 2 (NFR 우선순위)
├─ L2-Q1: 핵심 품질
├─ L2-Q2: 규모
├─ L2-Q3: 데이터 노출
└─ L2-Q4: 데이터 최신성
   ↓
Part 3: Layer 3 (환경 제약) ⭐
├─ L3-Q1: 기술 스택 제약 (외부 조사!)
├─ L3-Q2: 팀 역량
└─ L3-Q3: 배포 환경
   ↓
Part 4: 충돌 패턴 발견 ⭐
├─ Q4-1: NFR 달성 가능한가?
├─ Q4-2: 어떤 충돌이 있는가?
└─ Q4-3: 트레이드오프 필요한가?
   ↓
결과: 아키텍처 결정 + ADR (필요 시)
```

---

## 🎁 핵심 교훈

### 1. 핵심 기능 구분이 출발점

```
잘못 구분하면:
→ Layer 1 답변 혼란
→ 아키텍처 패밀리 선택 혼란
→ 전체 설계 틀어짐

올바르게 구분하면:
→ Layer 1 일관된 답변
→ 명확한 아키텍처 결정
→ 통합된 설계 가능
```

### 2. Layer 3 조사가 필수

```
특히 이런 도메인:
- 금융 (API 제한, 규제)
- 의료 (규제, 인증)
- 정부 (보안, 규제)
- 외부 API 의존

→ Layer 3 없이는 설계 불가능!
→ 외부 제약이 아키텍처를 결정!
```

### 3. 충돌은 정상이다

```
Layer 2: 이상적 목표
Layer 3: 현실적 제약
→ 충돌은 당연함!

중요한 것:
✅ 충돌을 발견하는 것
✅ 트레이드오프를 의식적으로 결정하는 것
✅ ADR로 결정 근거를 남기는 것
```

---

## 📚 실전 사례

### 사례 1: 주식 거래 플랫폼 (Phase 2)

**상세 문서**:
- `docs/session-summaries/20251112_Phase2_복합시스템_도전.md`
- `docs/session-summaries/20251112_핵심기능_판단기준.md`
- `docs/session-summaries/20251112_Layer3_외부제약조사.md`

**핵심 발견**:
- Part 0: 거래 = 1개 기능 (수동/자동 = 구현 방식)
- Part 3: 증권사 선택이 아키텍처 결정
- Part 4: 정확성 A + 즉시성 A vs API 20건/초 충돌

**결과**:
- Layer 1: A-C-A (새 패밀리 패턴!)
- Layer 2: A-B-B-A
- Layer 3: 한국투자증권 선택 (REST, 20건/초)
- 충돌 패턴: 트레이드오프 필요 (ADR 작성 예정)

---

## 🔗 관련 가이드

- **이전**: `01_CORE_DEFINITION_GUIDE.md` (핵심 정의)
- **다음**: `05_BLUEPRINT_GUIDE.md` (청사진 작성)
- **참고**: `04_PROJECT_STANDARDS_GUIDE.md` (프로젝트 표준)

---

**작성**: Jason + 2호 (Claude Code)
**최초 작성**: 2025-11-12
**버전**: v1.0
**상태**: Phase 2 실전 검증 중 발견사항 반영
