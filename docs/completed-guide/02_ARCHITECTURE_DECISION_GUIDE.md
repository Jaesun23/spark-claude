# Stage 1: 아키텍처 결정 가이드 (Architecture Decision Guide)

> **목적**: 핵심정의 결과를 바탕으로 아키텍처 결정 완성하기
>
> **버전**: v2.0 (2025-11-12)
> - v1.0: Layer 1-2-3 기본 구조
> - v2.0: Part 0 추가 (핵심 기능 재확인), Part 4 충돌 패턴 추가

---

## 📚 이 가이드의 구성

- **이 문서** (Guide): 질문 템플릿 + 체크리스트 (간결)
- **해설서** (Manual): 왜? 어떻게? 상세 설명 → `02-1_ARCHITECTURE_DECISION_MANUAL.md`
- **사례집** (Cases): 4가지 패밀리 실전 예시 → `02-2_IMPLEMENTATION_CASES.md`

---

## 📍 전체 프로세스에서의 위치

```
전체 프로세스:
Stage 0: 아이디어 → 핵심 정의 (01_CORE_DEFINITION_GUIDE.md) ✅
Stage 1: 아키텍처 결정 ← 이 가이드 ⭐
Stage 2: 청사진 작성 (05_BLUEPRINT_GUIDE.md)
Stage 3: 작업 분해 (06_TASK_BREAKDOWN_GUIDE.md)
Stage 4: 체크리스트 (07_CHECKLIST_GUIDE.md)
Stage 5: 구현
```

---

## Part 0: 준비 - 핵심 기능 재확인 ⭐

### 🎯 목표

**Stage 1로 넘어오기 전 최종 확인**:
- 01_CORE_DEFINITION에서 파악한 핵심 기능이 정확한가?
- Part 0에서 실수가 없었는가?

### ❓ 재확인 질문 3개

#### Q0-1: 비즈니스 목적으로 기능을 구분했는가?

**체크 방법**:
```
✅ 올바른 구분:
- "거래" (목적)
  ├─ 구현 방식 A: 수동
  └─ 구현 방식 B: 자동

❌ 잘못된 구분:
- "수동 거래" (구현 방식)
- "자동 거래" (구현 방식)
```

**실수 발견 시**: 01_CORE_DEFINITION으로 돌아가서 Part 0 재작성!

**상세 설명**: Manual 1.1절 참고

---

#### Q0-2: 실패의 비즈니스 영향이 구현 방식과 무관한가?

**체크 방법**:
```
주식 거래 예시:

방식 A (수동) 실패: 금전 손실 ✅
방식 B (자동) 실패: 금전 손실 ✅
→ 동일한 영향! 하나의 핵심 기능 맞음!
```

**상세 설명**: Manual 1.2절 참고

---

#### Q0-3: Layer 1 질문의 답이 명확한가?

**체크 방법**:
```
핵심 기능이 명확하면:
→ L1-Q1: 실패하면? (명확한 답)
→ L1-Q2: 정보 형태? (명확한 답)
→ L1-Q3: 응답 시점? (명확한 답)

핵심 기능이 불명확하면:
→ "어떤 기능 기준으로 답해야 하나?" 혼란!
```

**상세 설명**: Manual 1.3절 참고

---

### 📋 Part 0 체크리스트

Layer 1로 넘어가기 전에 확인:

- [ ] 구현 방식(How)이 아닌 비즈니스 목적(What)으로 기능을 구분했는가?
- [ ] 여러 구현 방식이 동일한 비즈니스 영향을 가지는가?
- [ ] Layer 1 질문에 명확히 답할 수 있는가?
- [ ] 핵심 기능 개수가 명확한가? (2개인 줄 알았는데 사실 1개?)

---

## Part 1: Layer 1 - 아키텍처 패밀리 재확인

### 🎯 목표

**01_CORE_DEFINITION에서 결정한 패밀리 재확인**:
- L1-Q1/Q2/Q3 답변이 일관되는가?
- 패밀리 패턴 (A-A-A, C-B-B 등)이 확정되었는가?

### ❗ 중요: 새로운 질문 아님!

```
이미 01_CORE_DEFINITION에서 답변 완료:
→ L1-Q1: 실패 파급력 (A / B / C)
→ L1-Q2: 정보 형태 (A / B / C)
→ L1-Q3: 응답 시점 (A / B / C)

여기서는 "재확인"만!
```

### 📋 패밀리 확인

**6가지 아키텍처 패밀리**:

| 패밀리 | 패턴 | 특징 | 예시 |
|--------|------|------|------|
| 1. CRUD/트랜잭션 | A-A-A | 정확성 중심 | 문서 생성, 주문 |
| 2. 검색/추천 | C-B-B | 관련성 중심 | AI 검색, 추천 |
| 3. 실시간 스트리밍 | B-C-A | 지연시간 중심 | IoT, 센서 |
| 4. 협업/동기화 | B-A-A | 일관성 중심 | Google Docs |
| 5. 분석/배치 | C-C-C | 처리량 중심 | ETL, BI |
| 6. 실시간 트랜잭션 ⭐ | A-C-A | 정확성+즉시성 | 주식 거래, 금융 |

**상세 설명**: Manual 2절 참고

---

## Part 2: Layer 2 - NFR 우선순위 재확인

### 🎯 목표

**01_CORE_DEFINITION에서 결정한 NFR 재확인**:
- L2-Q1/Q2/Q3/Q4 답변이 일관되는가?
- NFR 프로파일 (A-B-B-A 등)이 확정되었는가?

### ❗ 중요: 새로운 질문 아님!

```
이미 01_CORE_DEFINITION에서 답변 완료:
→ L2-Q1: 핵심 품질 (A / B / C)
→ L2-Q2: 규모 (A / B / C)
→ L2-Q3: 데이터 노출 (A / B / C)
→ L2-Q4: 데이터 최신성 (A / B / C)

여기서는 "재확인"만!
```

### 📋 NFR 프로파일

**출력 형식**: `L2-Q1: A, L2-Q2: B, L2-Q3: B, L2-Q4: A` → **A-B-B-A**

**상세 설명**: Manual 3절 참고

---

## Part 3: Layer 3 - 환경 제약 조사 ⭐⭐⭐

### 🎯 목표

**외부 제약 조건 파악** (실제 조사 필요!):
- L3-Q1: 기술 스택 제약 ← **외부 조사 필수!**
- L3-Q2: 팀 역량
- L3-Q3: 배포 환경

### ⚠️ 핵심 원칙: Layer 3가 아키텍처를 결정한다!

```
Phase 2 주식 거래 플랫폼에서 발견:
"금융 거래는 일반 시스템과 완전히 다르다!"

→ 증권사 API 사용 조건 조사 필요
→ 법적 규제 조사 필요
→ 제공자마다 조건이 다름!

→ Layer 3 없이는 설계 불가능!
```

---

### L3-Q1: 기술 스택 제약은? (외부 조사!)

#### Step 1: 외부 제약이 있는 도메인인가?

**체크 질문**:
```
□ 외부 API/서비스를 사용하는가?
□ 금융, 의료, 정부 등 규제 도메인인가?
□ 여러 제공자(증권사, 결제사 등) 중 선택이 필요한가?
□ 사용 제한(Rate Limit, 비용, 조건)이 있을 가능성이 있는가?
```

**하나라도 Yes → 외부 제약 조사 필수!**

#### Step 2: 무엇을 조사해야 하는가?

**주식 거래 플랫폼 예시**:
```
1. 증권사 API 비교
   □ 한국투자증권, 키움증권, 이베스트증권 등
   □ API 방식 (REST vs COM/DLL)
   □ Rate Limit (초당 몇 건?)
   □ OS 제약 (Windows vs 크로스플랫폼)
   □ 비용

2. 법적 규제
   □ 개인 사용 규제
   □ 서비스 제공 시 인허가
   □ 데이터 보관 의무

3. 개인정보보호
   □ 본인 정보만 처리 시
   □ 타인 정보 처리 시
```

**상세 설명 및 조사 방법**: Manual 4.1절 참고

#### Step 3: 제약 사항 정리

**비교표 작성 예시** (증권사 6개 비교):
```
| 증권사 | Rate Limit | API 방식 | OS 제약 | 평가 |
|--------|------------|----------|---------|------|
| 한투 | 20건/초 | REST | 크로스 | ⭐⭐⭐ |
| 키움 | 5건/초 | COM/DLL | Windows | ⭐⭐ |
| 이베스트 | 10건/초 | REST | 크로스 | ⭐⭐ |

→ 증권사 선택이 아키텍처를 결정!
```

**상세 사례**: `docs/session-summaries/20251112_Layer3_외부제약조사.md` 참고

---

### L3-Q2: 팀 역량은?

**가정 또는 확인**:
```
팀 구성:
- 백엔드: 1-2명 (Python/Node.js)
- 프론트엔드: 1명 (React/Next.js)
- 도메인 경험: 없음 (학습 필요)

기술 역량:
✅ 일반 웹 개발: 가능
✅ REST API, WebSocket: 가능
❓ 도메인 특수 사항: 학습 필요
```

**상세 설명**: Manual 4.2절 참고

---

### L3-Q3: 배포 환경은?

**확인 사항**:
```
개인 사용 프로젝트:
✅ 클라우드 (AWS, Azure, GCP) 가능
✅ 로컬 서버 가능
✅ Docker 컨테이너 가능

⚠️ 도메인별 제약 확인 필요:
- 금융: 증권사별 OS 제약
- 의료: 데이터 저장 위치 제약
- 정부: 보안 인증 제약
```

**상세 설명**: Manual 4.3절 참고

---

## Part 4: 충돌 패턴 발견 및 해결 ⭐⭐⭐

### 🎯 목표

**Layer 2 NFR vs Layer 3 제약 충돌 발견**:
- 충돌이 있는가?
- 트레이드오프가 필요한가?
- ADR 작성이 필요한가?

### ⚠️ 핵심 원칙: 충돌은 정상이다!

```
Layer 2: 이상적 목표 설정
Layer 3: 현실적 제약 발견
→ 대부분 충돌 발생!

→ 충돌을 발견하고 해결하는 게 아키텍처 결정의 핵심!
```

---

### 📋 충돌 체크 질문

#### Q4-1: Layer 2 NFR을 Layer 3 제약 내에서 달성 가능한가?

**주식 거래 플랫폼 예시**:
```
Layer 2 NFR:
- L2-Q1: 정확성 A (100% 정확)
- L2-Q4: 즉시성 A (초 단위)

Layer 3 제약:
- API 초당 20건

질문:
→ 초당 20건으로 100% 정확 + 즉시 감지 가능한가?
→ 관심 종목 50개 × 1초마다 확인 = 50건?
→ 불가능! 충돌 발생! ⚠️
```

**상세 설명**: Manual 5.1절 참고

---

#### Q4-2: 어떤 NFR과 어떤 제약이 충돌하는가?

**충돌 매트릭스 작성**:
```
| Layer 2 NFR | Layer 3 제약 | 충돌? | 영향 |
|-------------|--------------|-------|------|
| 정확성 A | API 20건/초 | ✅ | 모든 조건 실시간 감지 불가 |
| 즉시성 A | API 20건/초 | ✅ | 모든 종목 동시 모니터링 불가 |
| 보안 B | HTTPS 기본 | ❌ | 충돌 없음 |
| 규모 B | WebSocket 41건 | ✅ | 서비스화 시 부족 |
```

**상세 설명**: Manual 5.2절 참고

---

#### Q4-3: 트레이드오프가 필요한가?

**의사결정 필요**:
```
정확성 A vs API 20건/초:

옵션 1: 정확성 우선
- 우선순위 종목만 실시간 (20개)
- 나머지는 주기적 폴링 (느림)

옵션 2: 즉시성 우선
- 모든 종목 폴링 (50개)
- 2.5초마다 1회 확인

옵션 3: 균형
- 핵심 20개 실시간 (1초)
- 나머지 30개 주기적 (5초)

→ ADR 작성 필요!
```

**상세 설명**: Manual 5.3절 참고

---

### 📋 Part 4 체크리스트

- [ ] Layer 2 NFR 목표를 Layer 3 제약 내에서 달성 가능한가?
- [ ] 충돌하는 NFR과 제약을 모두 식별했는가?
- [ ] 각 충돌에 대한 트레이드오프 옵션을 정리했는가?
- [ ] ADR 작성이 필요한 중요한 결정이 있는가?

---

## 📊 전체 프로세스 요약

```
Part 0: 핵심 기능 재확인 ⭐
├─ Q0-1: 비즈니스 목적으로 구분했는가?
├─ Q0-2: 실패 영향이 구현 방식과 무관한가?
└─ Q0-3: Layer 1 질문의 답이 명확한가?
   ↓
Part 1: Layer 1 재확인
├─ L1-Q1: 실패 파급력
├─ L1-Q2: 정보 형태
└─ L1-Q3: 응답 시점
   ↓
Part 2: Layer 2 재확인
├─ L2-Q1: 핵심 품질
├─ L2-Q2: 규모
├─ L2-Q3: 데이터 노출
└─ L2-Q4: 데이터 최신성
   ↓
Part 3: Layer 3 조사 ⭐⭐⭐
├─ L3-Q1: 기술 스택 제약 (외부 조사!)
├─ L3-Q2: 팀 역량
└─ L3-Q3: 배포 환경
   ↓
Part 4: 충돌 패턴 발견 ⭐⭐⭐
├─ Q4-1: NFR 달성 가능한가?
├─ Q4-2: 어떤 충돌이 있는가?
└─ Q4-3: 트레이드오프 필요한가?
   ↓
결과: 아키텍처 결정 + ADR (필요 시)
```

---

## 🎁 핵심 교훈

### 1. 핵심 기능 구분이 출발점

```
잘못 구분하면:
→ Layer 1 답변 혼란
→ 아키텍처 패밀리 선택 혼란
→ 전체 설계 틀어짐

올바르게 구분하면:
→ Layer 1 일관된 답변
→ 명확한 아키텍처 결정
→ 통합된 설계 가능
```

### 2. Layer 3 조사가 필수

```
특히 이런 도메인:
- 금융 (API 제한, 규제)
- 의료 (규제, 인증)
- 정부 (보안, 규제)
- 외부 API 의존

→ Layer 3 없이는 설계 불가능!
→ 외부 제약이 아키텍처를 결정!
```

### 3. 충돌은 정상이다

```
Layer 2: 이상적 목표
Layer 3: 현실적 제약
→ 충돌은 당연함!

중요한 것:
✅ 충돌을 발견하는 것
✅ 트레이드오프를 의식적으로 결정하는 것
✅ ADR로 결정 근거를 남기는 것
```

---

## 다음 단계

**아키텍처 결정 완료 후**:
1. **구현방법** (Implementation Approach)
   - 5단계 프로세스
   - 속성 질문 → 구체적 수치

2. **ADR** (Architecture Decision Records)
   - 모든 중요 결정에 대한 "왜?"
   - **제약도 ADR이다!** (선택지가 1개여도 기록)

---

## 참고 문서

- **상세 해설**: `02-1_ARCHITECTURE_DECISION_MANUAL.md`
  - 왜 이 단계들인가?
  - 어떻게 조사하는가?
  - 충돌 패턴 상세 분석

- **실전 사례**: `02-2_IMPLEMENTATION_CASES.md`
  - Case 1: Memory (CRUD/트랜잭션)
  - Case 2: BioNeX (검색/추천)
  - Case 3: BlueprintAI (협업/동기화)
  - Case 4: Stock Trading (실시간 트랜잭션) ⭐

- **이론적 근거**: `../ARCHITECTURE_THEORY_MAPPING.md`
  - SEI Quality Attributes
  - Martin Fowler Patterns
  - CAP Theorem

---

**버전 이력**:
- v2.0 (2025-11-12): Part 0 추가, Part 4 충돌 패턴 추가
- v1.0 (2025-11-11): Layer 1-2-3 기본 구조
